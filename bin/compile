#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug
# set -x

shopt -s extglob

function error() {
  echo " !     $*" >&2
  exit 1
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}


#0 dir=/tmp/buildpacks/heroku-buildpack-r/bin/compile
#1 dir=/tmp/staged/app
#2 dir=/tmp/cache
_PWD=`pwd`
SYS_UNAME=`uname -a`
BUILD_DIR=$1
CACHE_DIR=$2
BUILDPACK_DIR="$(dirname $(dirname $0))"
R_FILE=R.tar.bz2
R_DOWNLOAD_URI="https://github.com/jtviegas/filerepo/raw/master/r/R.tar.bz2"
BASE_DIR=$BUILD_DIR/opt
R_DIR="$BASE_DIR/R"
CRAN_MIRROR="http://cran.ma.imperial.ac.uk"
APP_DIR="~/app"
mkdir -p $R_DIR

echo "Downloading and unpacking R binaries" | indent
wget --no-check-certificate $R_DOWNLOAD_URI
tar xjpvf $R_FILE -C $BASE_DIR && rm -f $R_FILE

echo "copying files to system" | indent
mkdir -p $APP_DIR/opt/R
cp -R $BASE_DIR/R/* $APP_DIR/opt/R/
cp -R $BUILD_DIR/*.r $APP_DIR/


# install dependencies from CRAN
export R_HOME="$APP_DIR/opt/R"
echo "R_HOME is $R_HOME"
echo "Executing init.r script" | indent
# set the CRAN mirror and run the init.r program
$APP_DIR/opt/R/bin/R -s <<RPROG > indent
  Sys.setenv(BUILD_DIR="$BUILD_DIR")
  setwd("$BUILD_DIR")
  r <- getOption("repos");
  r["CRAN"] <- "$CRAN_MIRROR";
  options(repos=r);
  `cat $APP_DIR/init.r`
RPROG

echo "R $R_VERSION successfully installed" | indent

# need to copy binaries back so that any installed packages are included in the slug
cp -R $APP_DIR/opt/R/* $BASE_DIR/R/
